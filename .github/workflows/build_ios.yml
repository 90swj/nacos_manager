name: Build iOS App with Free Apple ID  
  
on:  
  push:  
    branches: [ main ]  
  workflow_dispatch:  # 手动触发  
  release:  
    types: [published]  
  
jobs:  
  build:  
    runs-on: macos-latest  
      
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v4  # 已改为v4  
      
    - name: Set up Flutter  
      uses: subosito/flutter-action@v2  
      with:  
        channel: 'stable'  
      
    - name: Get dependencies  
      run: flutter pub get  
      
    - name: Build iOS app  
      run: flutter build ios --release --no-codesign  
      
    - name: Import certificates  
      env:  
        P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}  
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}  
      run: |  
        security create-keychain -p $KEYCHAIN_PASSWORD build.keychain  
        security set-keychain-settings -t 3600 build.keychain  
        security unlock-keychain -p $KEYCHAIN_PASSWORD build.keychain  
          
        echo ${{ secrets.IOS_CERTIFICATE_P12 }} | base64 --decode > certificate.p12  
        security import certificate.p12 -k build.keychain -P $P12_PASSWORD -T /usr/bin/codesign  
          
        security default-keychain -s build.keychain  
        security set-key-partition-list -S apple-tool:,apple:,codesign: -k $KEYCHAIN_PASSWORD build.keychain  
      
    - name: Codesign IPA (Archives agent)  
      run: |  
        cat > exportOptions.plist << EOF  
        <?xml version="1.0" encoding="UTF-8"?>  
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">  
        <plist version="1.0">  
        <dict>  
            <key>method</key>  
            <string>development</string>  
            <key>teamID</key>  
            <string>${{ secrets.TEAM_ID }}</string>  
            <key>provisioningProfiles</key>  
            <dict>  
                <key>${{ secrets.BUNDLE_ID }}</key>  
                <string>${{ secrets.PROVISIONING_PROFILE_UUID }}</string>  
            </dict>  
        </dict>  
        </plist>  
        EOF  
          
        xcodebuild -exportArchive \  
          -archivePath build/ios/archive/Runner.xcarchive \  
          -exportPath build/ios/ipa \  
          -exportOptionsPlist exportOptions.plist \  
          -allowProvisioningUpdates  
      
    # 关键修复：更新artifact上传地址  
    - name: UPLOAD IPA FILE  
      uses: actions/upload-artifact@v4  # 必须使用v4  
      with:  
        name: ios-app  
        path: build/ios/ipa/*.ipa  
        retention-days: 30  
      
    # 关键修复：更新Release上传格式  
    - name: UPLOAD TO GITHUB RELEASES  
      if: github.event_name == 'release'  
      uses: softprops/action-gh-release@v1  # 使用最新release插件  
      with:  
        files: build/ios/ipa/*.ipa  
      env:  
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
