name: Build iOS App with Free Apple ID  
  
on:  
  push:  
    branches: [ main ]  
  pull_request:  
    branches: [ main ]  
  workflow_dispatch:  # 允许手动触发  
  release:  
    types: [published]  
  
jobs:  
  build:  
    runs-on: macos-latest  
      
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v3  
      
    - name: Set up Flutter  
      uses: subosito/flutter-action@v2  
      with:  
        channel: 'stable'  
      
    - name: Get dependencies  
      run: flutter pub get  
      
    - name: Build iOS app  
      run: flutter build ios --release --no-codesign  
      
    - name: Import certificates  
      env:  
        P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}  
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}  
      run: |  
        # 创建临时密钥链  
        security create-keychain -p $KEYCHAIN_PASSWORD build.keychain  
        security set-keychain-settings -t 3600 build.keychain  
        security unlock-keychain -p $KEYCHAIN_PASSWORD build.keychain  
          
        # 导入证书  
        echo ${{ secrets.IOS_CERTIFICATE_P12 }} | base64 --decode > certificate.p12  
        security import certificate.p12 -k build.keychain -P $P12_PASSWORD -T /usr/bin/codesign  
          
        # 设置默认密钥链  
        security default-keychain -s build.keychain  
        security set-key-partition-list -S apple-tool:,apple:,codesign: -k $KEYCHAIN_PASSWORD build.keychain  
      
    - name: Codesign IPA  
      run: |  
        # 创建导出配置  
        cat > exportOptions.plist << EOF  
        <?xml version="1.0" encoding="UTF-8"?>  
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">  
        <plist version="1.0">  
        <dict>  
            <key>method</key>  
            <string>development</string>  
            <key>teamID</key>  
            <string>${{ secrets.TEAM_ID }}</string>  
            <key>provisioningProfiles</key>  
            <dict>  
                <key>${{ secrets.BUNDLE_ID }}</key>  
                <string>${{ secrets.PROVISIONING_PROFILE_UUID }}</string>  
            </dict>  
        </dict>  
        </plist>  
        EOF  
          
        # 导出IPA  
        xcodebuild -exportArchive \  
          -archivePath build/ios/archive/Runner.xcarchive \  
          -exportPath build/ios/ipa \  
          -exportOptionsPlist exportOptions.plist \  
          -allowProvisioningUpdates  
      
    - name: Upload IPA to GitHub Releases  
      if: github.event_name == 'release'  
      uses: actions/upload-release-asset@v1  
      env:  
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      with:  
        upload_url: ${{ github.event.release.upload_url }}  
        asset_path: build/ios/ipa/*.ipa  
        asset_name: app-release.ipa  
        asset_content_type: application/octet-stream  
      
    - name: Upload IPA for download  
      uses: actions/upload-artifact@v3  
      with:  
        name: ios-app  
        path: build/ios/ipa/*.ipa  
